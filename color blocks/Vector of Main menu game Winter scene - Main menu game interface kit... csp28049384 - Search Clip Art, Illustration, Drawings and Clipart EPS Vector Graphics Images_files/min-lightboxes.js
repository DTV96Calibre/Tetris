/**********************************************************************
 **********************************************************************
 ****  Can Stock Photo - Site JS Code
 ****  Copyright (c) 2011 Can Stock Photo Inc. 
 **********************************************************************
 **********************************************************************/
(function(fav,$,undefined){fav.trans=_.bind(window.canstockphoto.locale.trans,window.canstockphoto.locale);fav.CookieData=function(options){this._name=options.name;this._data=JSON.parse($.cookie(this._name))||options.defaults||{};this._store=function(){var data=JSON.stringify(this._data);$.cookie(this._name,data,{'expires':30,'path':'/'});};this.get=function(key){return(_.has(this._data,key))?this._data[key]:null;};this.set=function(key,value){if(!_.isEqual(this.get(key),value)){this._data[key]=value;this._store();this.trigger('change:'+key,value);}};};_.extend(fav.CookieData.prototype,Backbone.Events);fav.data=new fav.CookieData({'defaults':{'p':'m'},'name':'lbdat'});fav.AppModel=Backbone.Model.extend({'defaults':{'overflow':false,'sets':null,'set':null},'initialize':function(){_.bindAll(this,'itemsChange','setChange');this.thumbMenuView=new fav.ThumbMenuView({'model':this});fav.data.on('change:p',_.bind(this.changePreviewSize,this));this.get('sets').on('remove',_.bind(this.removeSet,this));this.get('sets').on('add',_.bind(this.addSet,this));this.bindSetEvents();this.bindEvents();},'parse':function(resp,xhr){resp.sets=this.processSets(resp.sets);resp.set=this.processSet(resp.sets);return resp;},'processSets':function(data){return new fav.SetCollection(data,{'parse':true});},'processSet':function(sets){var set=sets.get(fav.data.get('s'));if(_.isUndefined(set))set=this.updateCurrentSet(sets);fav.data.set('s',set.id);return set;},'changePreviewSize':function(size){_gaq.push(['_trackEvent','favorites','preview',size]);},'updateCurrentSet':function(sets){set=sets.first();if(_.isUndefined(set))sets.add(set=new fav.SetModel(null,{'parse':true}));return set;},'changeSelectedSet':function(set){if(_.isNull(set))set=this.updateCurrentSet(this.get('sets'));this.unbindSetEvents();this.set('set',set)
this.bindSetEvents();fav.data.set('s',set.id);this.setChange();},'selectSet':function(sid){this.changeSelectedSet(this.get('sets').get(sid));},'removeSet':function(model,collection){this.changeSelectedSet(null);},'addSet':function(model,collection){this.changeSelectedSet(model);},'bindEvents':function(){$(document).ready(_.bind(this.load,this));$(window).unload(_.bind(this.unload,this));$('body').on('click','.add2lightbox',_.bind(this.add,this));},'bindSetEvents':function(){this.unbindSetEvents();this.get('set').on('items:all',this.itemsChange);this.get('set').on('change sync',this.setChange);},'unbindSetEvents':function(){if(this.has('set')){this.get('set').off('items:all',this.itemsChange);this.get('set').off('change sync',this.setChange);}},'itemsChange':function(){this.trigger('items:change');},'setChange':function(){fav.data.set('s',this.get('set').id);this.trigger('set:change');},'getSearchPhrase':function(){return(typeof(window.canstockphoto.search)=='object')?window.canstockphoto.search.get_params().term:null;},'hasItem':function(pid){return this.get('set').hasItem(pid);},'addItem':function(pid){pid=parseInt(pid,10);this.trigger('item:added',pid);if(!this.get('set').hasItem(pid)){this.get('set').addItem({'phrase':this.getSearchPhrase(),'pid':pid});return true;}
return false;},'removeItem':function(pid){pid=parseInt(pid,10);this.trigger('item:removed',pid);if(this.get('set').hasItem(pid)){this.get('set').removeItem(pid)
return true;}
return false;},'add':function(event){this.addItem($(event.target).data('photo_id'));},'load':function(){this.footerView=new fav.FooterView({'model':this});$('body').append(this.footerView.render().el);},'unload':function(){if(this.footerView)this.footerView.close();}});fav.init=function(){console.log('INIT');$.ajax({'url':'/lightbox/api/1.0/sets','success':function(data){fav.appModel=new fav.AppModel({'sets':data},{'parse':true});},'type':'GET'});};})(window.cspFav=window.cspFav||{},jQuery);(function(fav,$,undefined){fav.SetModel=Backbone.Model.extend({'urlRoot':'/lightbox/api/1.0/sets','defaults':{'items':null,'name':'Main'},'initialize':function(attributes,options){this.on('sync',_.bind(this.bindItemEvents,this));this.bindItemEvents();},'bindItemEvents':function(){if(this.has('items'))this.get('items').on('all',_.bind(this.itemEvent,this));if(this.has('items'))this.get('items').sid=this.id;},'itemEvent':function(){this.trigger('items:'+_.first(arguments),_.rest(arguments));this.trigger('items:all',arguments);},'processItems':function(items){items=new fav.ItemCollection(items,{'parse':true});return items;},'parse':function(resp,xhr){resp.items=this.processItems(resp.items);return resp;},'downloadUrl':function(set){return this.url()+'/download/'+set;},'addItem':function(data){data.ord=this.get('items').length;if(this.isNew()){this.get('items').add(new fav.ItemModel(data));fav.data.set('d',1);this.save();}else{this.get('items').create(data);}},'removeItem':function(pid){if(this.hasItem(pid))this.getItem(pid).destroy();},'hasItem':function(pid){return(this.has('items')&&this.findItems(pid).length>=1);},'getItem':function(pid){return(this.hasItem(pid))?this.findItems(pid)[0]:null;},'findItems':function(pid){return this.get('items').where({'pid':parseInt(pid,10)});},'hasSelected':function(){return(this.get('items').where({'sel':true}).length>0)},'hasItems':function(){return(this.has('items')&&!this.get('items').isEmpty());}});})(window.cspFav=window.cspFav||{},jQuery);(function(fav,$,undefined){fav.ItemModel=Backbone.Model.extend({'defaults':{'pid':null,'txt':null,'ord':null,'sel':false},'validate':function(attrs){if(isNaN(attrs.pid))return'"pid" must be a number';if(_.isEmpty(attrs.txt))attrs.txt=null;},'cleanPhotoId':function(){return(this.get('pid')<1000000)?String('0000000'+this.get('pid')).slice(-7):this.get('pid');},'getThumbUrl':function(size){if(size=='xl')return this.getCompUrl();return'http://'+size+'.thumbs.canstockphoto.com/canstock'+this.cleanPhotoId()+'.jpg';},'getCompUrl':function(){return'http://comps.canstockphoto.com/can-stock-photo_csp'+this.cleanPhotoId()+'.jpg';}});})(window.cspFav=window.cspFav||{},jQuery);(function(fav,$,undefined){fav.SetCollection=Backbone.Collection.extend({'url':'/lightbox/api/1.0/sets','model':fav.SetModel,'initialize':function(models,options){this.on('add',_.bind(this.setAdded,this))},'setAdded':function(model,collection){this.each(function(loop_model){if(loop_model.isNew()&&!_.isEqual(model,loop_model))loop_model.destroy();});}});})(window.cspFav=window.cspFav||{},jQuery);(function(fav,$,undefined){fav.ItemCollection=Backbone.Collection.extend({'model':fav.ItemModel,'url':function(){return'/lightbox/api/1.0/sets/'+this.sid+'/items';},'comparator':function(item){return-item.get('ord');}});})(window.cspFav=window.cspFav||{},jQuery);(function(fav,$,undefined){var templates={'minimized':'<div class="minimized">'+'<%= trans("favorites") %>'+'<span class="caret"></span>'+'</div>'+'<div class="maximized"></div>'};fav.FooterView=Backbone.View.extend({'tagName':'div','className':'footer-lightbox','template':_.cspTemplate(templates.minimized),'events':{'click div.minimized':'click'},'initialize':function(){_.bindAll(this,'addFlash','updateDisplay');this.model.on('item:added item:removed',this.addFlash);fav.data.on('change:d',this.updateDisplay);this.menuView=new fav.FooterMenuView({'model':this.model});this.setView=new fav.FooterSetView({'model':this.model});},'addFlash':function(pid){this.$el.addClass('flash');_.delay(_.bind(this.removeFlash,this),300);},'removeFlash':function(){this.$el.removeClass('flash');},'render':function(){this.$el.html(this.template());this.$('div.maximized').append(this.menuView.render().el).append(this.setView.render().el);this.updateDisplay();return this;},'updateDisplay':function(){this.$('div.maximized').toggle(fav.data.get('d')>0);this.$('div.minimized').toggle(fav.data.get('d')<1);},'click':function(event){fav.data.set('d',1);},'onClose':function(){this.model.off('items:add items:remove',this.addFlash);fav.data.off('change:d',this.displayChange);this.menuView.close();this.setView.close();}});}(window.cspFav=window.cspFav||{},jQuery));(function(fav,$,undefined){var templates={'edit':'<form class="edit">'+'<label for="lightbox_set_name"><%= trans("name") %>:</label>'+'<input id="lightbox_set_name" name="name" type="text" value="<%= name %>">'+'</form>','menu':'<li><%= trans("favorites") %>:</li>'+'<li class="dropup white">'+'<span class="dropdown-toggle">'+'<%= set.get("name") %>'+'<i class="lightbox icon-blueUp"></i>'+'</span>'+'<ul class="dropdown-menu">'+'<li class="create">'+'<span>'+'<i class="lightbox icon-create"></i>'+'&nbsp;'+'<%= trans("createList") %>'+'</span>'+'</li>'+'<% sets.each(function(loop_set) { %>'+'<% if (!_.isEqual(set, loop_set)) { %>'+'<li class="select" data-id="<%= loop_set.id %>">'+'<span>'+'<%= loop_set.get("name") %>'+'</span>'+'</li>'+'<% } %>'+'<% }); %>'+'</ul>'+'</li>'+'<li class="dropup options">'+'<span class="dropdown-toggle" title="<%= trans("options") %>">'+'<i class="lightbox icon-cog"></i>'+'<span class="caret" style="margin-left:3px;"></span>'+'</span>'+'<ul class="dropdown-menu">'+'<% if (set.hasItems()) { %>'+'<li class="dropdown-submenu">'+'<span>'+'<%= trans("downloadComps") %>'+'</span>'+'<ul class="dropdown-menu comps">'+'<li class="download-selected">'+'<span>'+'<%= trans("selected") %>'+'</span>'+'</li>'+'<li class="download-all">'+'<span>'+'<%= trans("all") %>'+'</span>'+'</li>'+'</ul>'+'</li>'+'<% } %>'+'<li class="dropdown-submenu">'+'<span>'+'<%= trans("imageSize") %>'+'</span>'+'<ul class="dropdown-menu thumbsizes">'+'<% _.each(sizes, function(loop_size) { %>'+'<li class="thumbs" data-size="<%= loop_size.tag %>">'+'<span>'+'<i class="lightbox icon-checkbox <% if (loop_size.tag == size) { print("checked"); }  %>"></i>'+'<%= trans(loop_size.name) %>'+'</span>'+'</li>'+'<% }); %>'+'</ul>'+'</li>'+'<% if (set.hasItems()) { %>'+'<li class="view">'+'<span>'+'<%= trans("viewShareList") %>'+'</span>'+'</li>'+'<% } %>'+'<li class="create">'+'<span>'+'<%= trans("createList") %>'+'</span>'+'</li>'+'<li class="rename">'+'<span>'+'<%= trans("renameList") %>'+'</span>'+'</li>'+'<% if (!set.isNew()) { %>'+'<li class="delete">'+'<span>'+'<%= trans("deleteList") %>'+'</span>'+'</li>'+'<% } %>'+'</ul>'+'</li>'+'<% if (set.hasItems()) { %>'+'<li class="dropup">'+'<span class="dropdown-toggle">'+'<%= trans("download") %>'+'<span class="caret" style="margin-left:3px;"></span>'+'</span>'+'<ul class="dropdown-menu downloads">'+'<li class="download-selected">'+'<span>'+'<%= trans("selected") %>'+'</span>'+'</li>'+'<li class="download-all">'+'<span>'+'<%= trans("all") %>'+'</span>'+'</li>'+'</ul>'+'</li>'+'<% } %>'+'<li class="visibility-nav">'+'<i class="lightbox icon-up"></i>'+'<i class="lightbox icon-down"></i>'+'</li>','noneSelected':'<div style="text-align:center;">'+'<img src="/media/img/_app/lightboxes/help/select_item.jpg" />'+'<p>'+'<%= trans("selectItemsHelp") %>'+'</p>'+'</div>'};var image_sizes=[{'name':'large','tag':'l'},{'name':'medium','tag':'m'},{'name':'small','tag':'s'}];fav.FooterMenuView=Backbone.View.extend({'tagName':'ul','className':'menu-lightbox','template':_.cspTemplate(templates.menu),'editTemplate':_.cspTemplate(templates.edit),'events':{'click ul.thumbsizes li.thumbs':'setThumbSize','click ul.comps li.download-selected':'compsDownloadSelected','click ul.comps li.download-all':'compsDownloadAll','click ul.downloads li.download-selected':'downloadSelected','click ul.downloads li.download-all':'downloadAll','click i.icon-down':'menuDown','click i.icon-up':'menuUp','click li.select':'select','click li.rename':'rename','click li.delete':'delete','click li.create':'create','click li.view':'view'},'initialize':function(options){_.bindAll(this,'render','itemAdded','displayChange');this.$iframe=$('<iframe/>').addClass('download_iframe');this.model.on('set:change items:change',this.render);this.model.on('change:overflow',this.displayChange);fav.data.on('change:d',this.displayChange);},'itemAdded':function(model,collection){if(collection.length<=1)this.render();},'render':function(){this.$el.html(this.template({'sets':this.model.get('sets'),'set':this.model.get('set'),'size':fav.data.get('p'),'sizes':image_sizes}));this.displayChange();this.setupMenus();return this;},'setupMenus':function(){this.$('.dropdown-toggle').dropdown();},'select':function(event){this.model.selectSet($(event.currentTarget).data('id'));},'view':function(event){window.location.href="/lightbox/"+this.model.get('set').get('key')+"/";},'edit':function(data){var modal=new fav.ModalView({'heading':data.heading,'body':this.editTemplate(data.bodyData),'events':{'submit form.edit':_.bind(function(event){this.stopEvent(event);data.success(modal);},this)},'buttons':[{'text':fav.trans('cancel'),'click':function(modal){modal.hide();}},{'text':data.saveButton,'class':'btn-success','click':data.success}]});},'rename':function(event){this.edit({'heading':fav.trans('renameList'),'saveButton':fav.trans('renameList'),'bodyData':this.model.get('set').toJSON(),'success':_.bind(this.renameSet,this)});},'renameSet':function(modal){var data=modal.$('form.edit').serializeObject();this.model.get('set').save(data);modal.hide();},'create':function(event){this.edit({'heading':fav.trans('createList'),'saveButton':fav.trans('createList'),'bodyData':{'name':''},'success':_.bind(this.createSet,this)});},'createSet':function(modal){var set=new fav.SetModel(modal.$('form.edit').serializeObject(),{'parse':true});this.model.get('sets').add(set);set.save();modal.hide();},'delete':function(event){new fav.ModalView({'heading':fav.trans('deleteList'),'body':fav.trans('confirmDelete',{'{item_name}':'"'+this.model.get('set').get('name')+'"'}),'buttons':[{'text':fav.trans('cancel'),'click':function(modal){modal.hide();}},{'text':fav.trans('deleteList'),'class':'btn-danger','click':_.bind(this.deleteSet,this)}]});},'deleteSet':function(modal){this.model.get('set').destroy();modal.hide();},'downloadZip':function(set){$('body').append(this.$iframe);this.$iframe.attr('src',this.model.get('set').downloadUrl(set));},'compsDownloadSelected':function(){if(!this.showSelectHelp()){this.downloadZip('selected');}},'compsDownloadAll':function(){this.downloadZip('all');},'downloadSelected':function(){if(!this.showSelectHelp()){(new fav.DownloadView({'model':this.model.get('set'),'mode':'selected'})).render();}},'downloadAll':function(){(new fav.DownloadView({'model':this.model.get('set'),'mode':'all'})).render();},'displayChange':function(){this.$('i.icon-down').toggleClass('hide',(fav.data.get('d')<=0));this.$('i.icon-up').toggleClass('hide',(fav.data.get('d')!=0&&(fav.data.get('d')>=5||!this.model.get('overflow'))));},'adjustDisplay':function(adjust){fav.data.set('d',Math.min(5,Math.max(0,fav.data.get('d')+adjust)));this.displayChange();},'menuDown':function(event){this.adjustDisplay(-1);},'menuUp':function(event){this.adjustDisplay(1);},'showSelectHelp':function(){if(this.model.get('set').hasSelected()){return false;}else{new fav.ModalView({'heading':fav.trans('noneSelected'),'body':_.cspTemplate(templates.noneSelected,{}),'buttons':[{'text':fav.trans('cancel'),'click':function(modal){modal.hide();}}]});return true;}},'setThumbSize':function(event){fav.data.set('p',$(event.currentTarget).data('size'));this.render();},'onClose':function(){this.model.off('set:change items:change',this.render);this.model.off('change:overflow',this.displayChange);fav.data.off('change:d',this.displayChange);this.$iframe.remove();}});}(window.cspFav=window.cspFav||{},jQuery));(function(fav,$,undefined){var templates={'modal':'<div class="modal-header">'+'<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>'+'<h3><%= heading %></h3>'+'</div>'+'<div class="modal-body">'+'<%= body %>'+'</div>'+'<div class="modal-footer">'+'<% _.each(buttons, function(value, key, list) { %>'+'<span class="btn <% if (_.has(value, "class")) {print(value["class"]);} %>" data-btnkey="<%= key %>">'+'<%= value.text %>'+'</span>'+'<% }); %>'+'</div>'};fav.ModalView=Backbone.View.extend({'tagName':'div','className':'modal hide fade','template':_.cspTemplate(templates.modal),'events':{'click span.btn':'buttonClick','hidden':'close','shown':'onShow'},'initialize':function(options){this.options=_.extend({'buttons':[],'events':{}},options);this.events=_.extend(this.events,this.options.events);this.processButtons();this.show();},'processButtons':function(){this.buttons={};_.each(this.options.buttons,function(element,index,list){this.buttons['btn'+index]=element;},this);},'render':function(){this.$el.html(this.template({'buttons':this.buttons,'heading':this.options.heading,'body':this.options.body}));},'onShow':function(){if(this.onLoad)this.onLoad();},'show':function(){this.render();$('body').append(this.el);this.$el.modal();},'hide':function(){this.$el.modal('hide');},'buttonClick':function(event){var button=this.buttons[$(event.target).data('btnkey')];if(_.has(button,'click'))button.click(this);}});}(window.cspFav=window.cspFav||{},jQuery));(function(fav,$,undefined){var templates={'item':'<div class="item-container">'+'<input class="select-lightbox hover-show" type="checkbox" '+'<% if (item.get("sel")) { %>'+'checked="checked" '+'<% } %>'+'title="<%= trans("select").capitalize() %>" />'+'<i class="lightbox icon-delete icon-background remove-lightbox hover-show" title="<%= trans("removeFromFavorites") %>"></i>'+'<a href="/file_view.php?id=<%= item.cleanPhotoId() %>">'+'<img class="item-image" src="<%= item.getThumbUrl(size) %>"/>'+'</a>'+'</div>'};fav.FooterSetView=Backbone.View.extend({'items':null,'tagName':'ul','className':'images-lightbox','initialize':function(options){_.bindAll(this,'render','displayChange');this.model.on('set:change items:change',this.render);fav.data.on('change:d',this.displayChange);fav.data.on('change:p',this.render);},'render':function(){this.preview_size=fav.data.get('p')||'m';this.trigger('closeSubViews');this.model.get('set').get('items').each(_.bind(this.renderItem,this));this.displayChange();return this;},'renderItem':function(item){this.$el.append((new fav.ImageView({'view':this,'model':item})).render().el);},'getDisplayHeight':function(){var map={'s':37,'m':77,'l':103};return fav.data.get('d')*map[this.preview_size]},'displayChange':function(){this.$el.height(this.getDisplayHeight());this.model.set('overflow',this.$el.hasOverflow());},'onClose':function(){this.model.off('set:change items:change',this.render);fav.data.off('change:d',this.displayChange);fav.data.off('change:p',this.render);this.trigger('closeSubViews');}});fav.ImageView=Backbone.View.extend({'tagName':'li','className':'item','previewTimeout':null,'template':_.cspTemplate(templates.item),'events':{'click button.delete_item':'delete','click i.remove-lightbox':'removeItem','mouseenter i.remove-lightbox':'toggleRemove','mouseleave i.remove-lightbox':'toggleRemove','change input.select-lightbox':'toggleSelect','mouseenter div.item-container':'togglePreview','mouseleave div.item-container':'togglePreview'},'initialize':function(options){_.bindAll(this,'close');this.parentView=options.view;this.parentView.on('closeSubViews',this.close);},'render':function(){this.$el.html(this.template({'size':this.parentView.preview_size,'item':this.model})).addClass('tsize-'+this.parentView.preview_size);this.$('.hover-show').hide();this.setSelected();return this;},'delete':function(event){this.model.destroy();this.close();},'setSelected':function(){this.$el.toggleClass('selected-lightbox',this.model.get('sel'));},'toggleRemove':function(event){this.$el.toggleClass('remove-lightbox',(event.type=='mouseenter'));},'toggleSelect':function(event){this.model.save({'sel':this.$('input.select-lightbox').is(':checked')});this.setSelected();},'showPreview':function(){this.previewView=new fav.PreviewView({'model':this.model,'size':{'h':this.$('img.item-image').height(),'w':this.$('img.item-image').width()}});this.$el.append(this.previewView.render().el);},'hidePreview':function(){if(this.previewView)this.previewView.close();window.clearTimeout(this.previewTimeout);this.previewTimeout=null;},'togglePreview':function(event){this.hidePreview();if(event.type=='mouseenter'){this.previewTimeout=window.setTimeout(_.bind(this.showPreview,this),100);this.$('.hover-show').show();}else{this.$('.hover-show').hide();}},'removeItem':function(event){this.model.destroy();this.close();this.parentView.displayChange();},'onClose':function(){this.parentView.off('closeSubViews',this.close);if(this.previewView)this.previewView.close();}});}(window.cspFav=window.cspFav||{},jQuery));(function(fav,$,undefined){var templates={'preview':'<div class="preview-lightbox-inner">'+'<img src="<%= url %>" class="preview" />'+'</div>'+'<% if (item.has("txt")) { %>'+'<div class="notes"><%= item.get("txt").nl2br() %></div>'+'<% } %>'};fav.PreviewView=Backbone.View.extend({'comp_long_side':450,'tagName':'div','className':'preview-lightbox','template':_.cspTemplate(templates.preview),'initialize':function(options){_.bindAll(this,'comp_load');this.size_data={'thumb':options.size,'comp':{}};this.get_size_data();},'load_comp':function(){this.comp=$(new Image()).addClass('watermark');this.comp.on('load',this.comp_load);this.comp.attr('src',this.model.getCompUrl());},'get_size_data':function(){this.size_data.orientation=(this.size_data.thumb.w>this.size_data.thumb.h);this.size_data.comp.w=Math.floor((this.size_data.orientation)?this.comp_long_side:Math.floor((this.comp_long_side/this.size_data.thumb.h)*this.size_data.thumb.w));this.size_data.comp.h=Math.floor((this.size_data.orientation)?Math.floor((this.comp_long_side/this.size_data.thumb.w)*this.size_data.thumb.h):this.comp_long_side);},'set_sizes':function(){this.$('img.thumb, div.preview-lightbox-inner').width(this.size_data.comp.w).height(this.size_data.comp.h);},'comp_load':function(event){this.$el.html(this.template({'url':this.model.getCompUrl('s'),'item':this.model}));this.$('img.preview').addClass('watermark');this.set_sizes();},'render':function(){this.$el.html(this.template({'url':this.model.getThumbUrl('s'),'item':this.model}));this.$('img.preview').addClass('thumb');this.set_sizes();this.load_comp();return this;},'onClose':function(){this.comp.off('load',this.comp_load);}});}(window.cspFav=window.cspFav||{},jQuery));(function(fav,$,undefined){window.canstockphoto.locale.trans('download');var templates={'modal':'<div class="modal-header">'+'<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>'+'<h3>'+window.canstockphoto.locale.trans('download')+' "<%= set.get("name") %>"</h3>'+'</div>'+'<div class="modal-body">'+''+window.canstockphoto.locale.trans('loading')+'...'+'</div>'+'<div class="modal-footer">'+'<span class="btn cancel">'+window.canstockphoto.locale.trans('cancel')+'</span>'+'<span class="btn btn-success download">'+window.canstockphoto.locale.trans('download')+'</span>'+'</div>','item':'<img class="item-image" src="<%= item.getThumbUrl("s") %>"/>'+'<span><%= item.get("type") %></span>'};fav.DownloadView=Backbone.View.extend({'tagName':'div','className':'lightbox-download modal hide fade','template':_.cspTemplate(templates.modal),'events':{'click span.download':'process','submit #dl_wrapper':'submit','click span.cancel':'hide','hidden':'close'},'initialize':function(options){this.mode=options.mode;},'render':function(){this.$el.html(this.template({'set':this.model}));$.ajax({'success':_.bind(this.load,this),'url':'/lightbox/download.php','dataType':'html','type':'GET','data':{'set':this.model.id,'mode':this.mode}});$('body').append(this.el);this.$el.modal();},'process':function(event){if(!this.$('span.download').hasClass('disabled'))
this.$('#dl_wrapper').submit();},'submit':function(event){if(!this.$('#i_accept').is(':checked')){alert(this.$('#dl_glos_licenseterms').text());return false;}else{this.$('span.download').addClass('disabled');}},'load':function(data){this.$('div.modal-body').html(data);fav.modalLoaded();},'hide':function(event){this.$el.modal('hide');},'onClose':function(){}});function dl_format_price(amount){var decimals=2;var prefix='';var surfix='';if($('#dl_glos_currency').text()=='USD'){prefix='$';}else{prefix=$('#dl_glos_currency_leading_symbol').text();surfix=$('#dl_glos_currency_trailing_symbol').text();}
amount=parseInt(amount);total_str=amount.toFixed(decimals).toString();temp_total=total_str.substr(0,total_str.length-(decimals+1));temp_total+=$('#dl_glos_decimal_symbol').text();temp_total+=total_str.substr(total_str.length-decimals);total_str=temp_total;return prefix+total_str+surfix;}
function update_numbering(){var num=0;$(".dl_num").each(function(index){num++;$(this).html(num);});$(".dl_total_num").html(num);if(num==0){$('div.lightbox-download.modal').modal('hide');}}
var old_warnings=0;function update_price(){var total_price=0;var total_credits=0;var total_credits_value=0;var total_sub_dls=0;var total_display="";$(".dl_size select").each(function(index){$("#"+$(this).attr("id")+" > option").each(function(){if(num_sub_dls>total_sub_dls&&((num_sub_type==0&&this.value<=3)||(num_sub_type==1&&this.value<=5))){var text=this.text;text=text.substring(0,text.indexOf(')'));this.text=text+") "+$("#dl_glos_included").text();}else if(parseInt(pricing[this.value].credits)<=(num_credits-total_credits)){var text=this.text;text=text.substring(0,text.indexOf(')'));this.text=text+") "+pricing[this.value].credits+" "+$("#dl_glos_credits").text();}else{var text=this.text;text=text.substring(0,text.indexOf(')'));this.text=text+") "+dl_format_price(pricing[this.value].price);}});var size=$(this).val();if(num_sub_dls>total_sub_dls&&((num_sub_type==0&&size<=3)||(num_sub_type==1&&size<=5))){total_sub_dls++;$(this).prev().val("sub");}else if(parseInt(pricing[size].credits)<=(num_credits-total_credits)){total_credits=parseInt(pricing[size].credits)+total_credits;total_credits_value=parseInt(pricing[size].credits)+total_credits_value;$(this).prev().val("cred");}else{total_price=parseFloat(pricing[size].price)+total_price;total_credits_value=parseInt(pricing[size].credits)+total_credits_value;$(this).prev().val("cash");}});if(total_credits>0){$("#dl_total_cred_ara").show();$("#dl_total_cred_num").html(total_credits);}else{$("#dl_total_cred_ara").hide();}
if(total_credits>0&&total_price>0){$("#dl_total_plus").show();}else{$("#dl_total_plus").hide();}
if(total_price>0){$(".dl_total_dollar").show();$(".dl_total_dollar").html(dl_format_price(total_price));}else{$(".dl_total_dollar").hide();}
if(total_price==0&&total_credits==0&&total_sub_dls>0){$("#dl_total_included").show();}else{$("#dl_total_included").hide();}
var new_warnings=0;if(total_credits>0&&total_price>0){$("#dl_extra_credits").slideDown(200);$("#num_cred_over").html(total_credits_value-num_credits);$("#total_credits_value").html(total_credits_value);new_warnings++;}else{$("#dl_extra_credits").slideUp(200);}
if(num_sub_dls>0&&total_price>0){$("#dl_extra_sub").slideDown(200);$("#total_sub_dls").html(total_sub_dls);update_numbering();new_warnings++;}else{$("#dl_extra_sub").slideUp(200);}
if(new_warnings!=old_warnings){$("#dl_items_container").animate({"max-height":(300-(new_warnings*60))+"px"},200);$("#dl_extra_credits, #dl_extra_sub").promise().done(function(){$("#dl_items_container").animate({"max-height":(300-$("#dl_alert_area").height())+"px"},100);});old_warnings=new_warnings;}}
fav.modalLoaded=function(){$('.dl_size select').change(function(){update_price();});$("#dl_size_apply").click(function(){$(".dl_size select").each(function(index){$('#'+$(this).attr("id")).val($("#dl_size_select").val());});update_price();});$(".dl_item").bind("mouseenter",function(){$(this).css("background","#EBF4FA");}).bind("mouseleave",function(){$(this).css("background","#fff");});$(".dl_remove img").click(function(){$(this).parent().parent().slideUp(200,function(){$(this).remove();update_numbering();update_price();});});var avail_sizes=[];$(".dl_size select").each(function(index){if($('#'+$(this).attr("id")+' option[value=9]').length>0){$(this).val('9');}else if($('#'+$(this).attr("id")+' option[value=8]').length>0){$(this).val('8');}else if(num_sub_dls>0&&num_sub_type==0){$(this).val('3');}else if($('#'+$(this).attr("id")+' option[value=5]').length>0){$(this).val('5');}else if($('#'+$(this).attr("id")+' option[value=4]').length>0){$(this).val('4');}else{$(this).val('3');}
$("#"+$(this).attr("id")+" > option").each(function(){avail_sizes.push($(this).val());});});var larges_size="";for(var x=0;x<avail_sizes.length;x++){var size=avail_sizes[x];$("<option/>").val(size).text(pricing[size].name).appendTo("#dl_size_select");larges_size=size;}
$("#dl_size_select").val(larges_size);update_price();};}(window.cspFav=window.cspFav||{},jQuery));(function(fav,$,undefined){fav.ThumbMenuView=Backbone.View.extend({'tagName':'div','className':'add_fav_icon','src_regex':/([0-9]{7,8})\.jpg/i,'events':{'click':'click'},'initialize':function(options){$(document).on('mouseenter mouseleave','span.thumb-container:not(.noFav)',_.bind(this.overThumb,this));this.model.on('set:change items:change',_.bind(this.markInFavs,this));$(document).on('images_displayed',_.bind(this.markInFavs,this));this.markInFavs();},'getPhotoId':function(src){return(this.src_regex.test(src))?this.src_regex.exec(src)[1]:null;},'updateElement':function(){this.inFav=this.model.hasItem(this.photo_id);this.$el.toggleClass('inFav',this.inFav);this.$el.attr('title',(this.inFav)?fav.trans('removeFromFavorites'):fav.trans('addToFavorites'));},'overThumb':function(event){if(event.type=='mouseenter'){var thumb=$(event.currentTarget).find('img.thumb-hover, img.thumb-click');this.photo_id=this.getPhotoId(thumb.attr('src'));this.updateElement();$(event.currentTarget).append(this.$el);}else{this.$el.detach();}},'click':function(event){event.preventDefault();event.stopPropagation();this.model[(!this.inFav)?'addItem':'removeItem'](this.photo_id);this.updateElement();},'markInFavs':function(){$('img.thumb-hover, img.thumb-click').each(_.bind(this.markInFav,this));},'markInFav':function(idx,elem){var $elem=$(elem),inFav=this.model.hasItem(this.getPhotoId($elem.attr('src')));$elem.closest('span.thumb-container').toggleClass('inFav',inFav);}});})(window.cspFav=window.cspFav||{},jQuery);